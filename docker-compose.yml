services:
  neo4j:
    image: neo4j:5
    ports:
      - "7474:7474" # Neo4j Browser / HTTP
      - "7687:7687" # Bolt (used by Neo4j Browser + external tools)
    environment:
      # Override in your shell or a local .env file (not committed)
      # Example: NEO4J_PASSWORD=localdev123
      # Neo4j rejects the literal password "neo4j", so the default here is "localdev123".
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-localdev123}
      # Allow connections from other containers (compose network)
      - NEO4J_server_default__listen__address=0.0.0.0
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs

  agent:
    build:
      context: ./agent
    ports:
      - "8123:8123"
    depends_on:
      - neo4j
    # Optional: set Jira/Anthropic/etc env vars here or in your shell.
    # (We don't reference ./agent/.env directly because compose fails if it doesn't exist.)
    environment:
      # Helps file watching in bind mounts on some hosts
      - PYTHONUNBUFFERED=1
      # Neo4j connection info (for when you switch off mock tools)
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-localdev123}
    volumes:
      # Hot-reload agent code/config
      - ./agent:/app
      # Keep venv inside a named volume (so bind-mount doesn't wipe it)
      - agent_venv:/app/.venv
      - agent_uv_cache:/root/.cache/uv

  ui:
    build:
      context: .
    ports:
      - "3000:3000"
    stdin_open: true
    tty: true
    depends_on:
      - agent
    environment:
      # IMPORTANT: inside compose, "localhost" would be the ui container.
      - LANGGRAPH_DEPLOYMENT_URL=http://agent:8123
      # Helps file watching in bind mounts on macOS/Windows
      - WATCHPACK_POLLING=true
    volumes:
      # Hot-reload UI source
      - ./src:/app/src
      - ./public:/app/public
      # Keep node_modules inside container (avoid bind-mount overwriting it)
      - ui_node_modules:/app/node_modules
      - ui_next_cache:/app/.next

volumes:
  agent_venv:
  agent_uv_cache:
  ui_node_modules:
  ui_next_cache:
  neo4j_data:
  neo4j_logs:
