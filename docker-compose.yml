services:
  neo4j:
    # Using 2025 version to match the data format from backup
    image: neo4j:2025
    ports:
      - "7474:7474" # Neo4j Browser / HTTP
      - "7687:7687" # Bolt (used by Neo4j Browser + external tools)
    environment:
      # Disable auth for local dev (the imported data may have its own credentials)
      - NEO4J_AUTH=none
      # Allow connections from other containers (compose network)
      - NEO4J_server_default__listen__address=0.0.0.0
      # Keep Neo4j memory footprint small for dev (Podman VM is often 2GiB by default)
      - NEO4J_server_memory_heap_initial__size=256m
      - NEO4J_server_memory_heap_max__size=256m
      - NEO4J_server_memory_pagecache_size=256m
    volumes:
      # Use local data directory with pre-populated Neo4j data
      - ./data/neo4jdata:/data
      - neo4j_logs:/logs

  agent:
    build:
      context: ./agent
    ports:
      - "8123:8123"
    depends_on:
      - neo4j
    # Optional: set Jira/Anthropic/etc env vars here or in your shell.
    # (We don't reference ./agent/.env directly because compose fails if it doesn't exist.)
    environment:
      # Helps file watching in bind mounts on some hosts
      - PYTHONUNBUFFERED=1
      # LLM API key (loaded from .env file via compose substitution)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Model selection (defaults to claude-sonnet-4-5 if not set)
      - N9_AGENT_MODEL=${N9_AGENT_MODEL:-gpt-4o}
      # Neo4j connection info (auth disabled for local dev)
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=
      - NEO4J_PASSWORD=
    volumes:
      # Hot-reload agent code/config
      - ./agent:/app
      # Keep venv inside a named volume (so bind-mount doesn't wipe it)
      - agent_venv:/app/.venv
      - agent_uv_cache:/root/.cache/uv

  ui:
    build:
      context: .
    ports:
      - "3000:3000"
    stdin_open: true
    tty: true
    depends_on:
      - agent
    environment:
      # Increase Node.js heap for webpack compilation (needs ~2GB for CopilotKit deps)
      - NODE_OPTIONS=--max-old-space-size=2048
      # IMPORTANT: inside compose, "localhost" would be the ui container.
      - LANGGRAPH_DEPLOYMENT_URL=http://agent:8123
      # Helps file watching in bind mounts on macOS/Windows
      - WATCHPACK_POLLING=true
    volumes:
      # Hot-reload UI source
      - ./src:/app/src
      - ./public:/app/public
      # Keep node_modules inside container (avoid bind-mount overwriting it)
      - ui_node_modules:/app/node_modules
      - ui_next_cache:/app/.next

volumes:
  agent_venv:
  agent_uv_cache:
  ui_node_modules:
  ui_next_cache:
  neo4j_data:
  neo4j_logs:
